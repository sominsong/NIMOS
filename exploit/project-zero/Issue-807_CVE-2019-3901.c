//gcc -std=gnu99 -Wall -o test test.c
#define _GNU_SOURCE
#include <stdio.h>
#include <unistd.h>
#include <err.h>
#include <inttypes.h>
#include <assert.h>
#include <errno.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <sys/mman.h>
#include <sys/wait.h>

#include <linux/perf_event.h>
#include <linux/hw_breakpoint.h>
#include <asm/perf_regs.h>

#include "test_info.h"

struct my_event {
    struct perf_event_header header;
    uint64_t   abi;
    uint64_t   regs[1];
};

long perf_event_open(struct perf_event_attr *attr, pid_t pid, int cpu, int group_fd, unsigned long flags) {
	return syscall(__NR_perf_event_open, attr, pid, cpu, group_fd, flags);
}

int main(void) {
	pid_t child = fork();
	if (child == -1)
		return -1;
		// err(1, "fork");
	if (child == 0) {
		execl("./victim", "victim", NULL);
		return -1;
		// err(1, "execl");
	}
	struct perf_event_attr attr = {
		.type = PERF_TYPE_BREAKPOINT,
		.size = sizeof(struct perf_event_attr),
		.bp_type = HW_BREAKPOINT_X,
		.bp_addr = PID_IN_RAX_ADDR,
		.bp_len = sizeof(long),
		.sample_period = 1,
		.sample_type = PERF_SAMPLE_REGS_USER,
		.exclude_kernel = 1,
		.exclude_hv = 1,
		.exclude_idle = 1,
		.precise_ip = 2,
		.sample_regs_user = (1ULL << PERF_REG_X86_AX)
	};
	int perf_fd = perf_event_open(&attr, child, -1, -1, 0);
	if (perf_fd == -1 && errno == EACCES) {
		// puts("too late");
		return 0;
	}
	if (perf_fd == -1)
		return -1;
		// err(1, "perf_event_open");
	struct perf_event_mmap_page *meta_page = mmap(NULL, 2*4096, PROT_READ|PROT_WRITE, MAP_SHARED, perf_fd, 0);
	if (meta_page == MAP_FAILED)
		return -1;
		// err(1, "mmap");

	int status;
	if (waitpid(child, &status, 0) != child)
		return -1;
		// err(1, "waitpid");

	uint64_t data_head = meta_page->data_head;
	asm volatile("lfence":::"memory");
	if (data_head == 0) {
		// puts("too early");
		return 0;
	}
	// printf("data_head is at %lx\n", data_head);
	struct perf_event_header *head = (void*)((char*)meta_page + 4096);
	assert(head->type == PERF_RECORD_SAMPLE);
	assert(head->size == data_head);
	struct my_event *ev = (void*)head;
	// printf("RAX: %"PRIu64"\n", ev->regs[0]);
	return 0;
}
